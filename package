#! /usr/bin/env python3

import os

print('Welcome to the Workiva Platform!')

# TODO: look for a Dockerfile parser that enables access to EXPOSEd ports
ports = [
    int(p)
    for l in open('Dockerfile').readlines()
    for p in l[7:].strip().split() # len('EXPOSE ')
    if l.startswith('EXPOSE')
]
port = None
if not len(ports):
    print('No PORT Detected in Dockerfile: Using 8888')
    port = 8888
else:
    print('Found exposed ports: %s; Using %d for readiness probe' % (ports, ports[0]))
    port = ports[0]


print('Building HELM Artifacts...')

# TODO: append liveness checks if not present

defaultReadinessProbe = """
# The readinessProbe defines when your service is considered ready for traffic.
# See: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/
readinessProbe:
  httpGet:
    path: /_wk/ready
    port: %d
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 10
  successThreshold: 1
  failureThreshold: 3
"""

for dirpath, _, filenames in os.walk('.'):
    if 'values.yaml' not in filenames:
        continue
    file = os.sep.join([dirpath, 'values.yaml'])
    found = any([l.startswith('readinessProbe:') for l in open(file).readlines()])
    if not found:
        open(file, 'a').write(defaultReadinessProbe % port)

os.system('helm package *')
print('DONE!')

print('Your Service is now ready for Deployment through Release Pipelines')
