name: go-unit
image: golang:1.12
contact: Nate Woods (nate.woods@workiva.com)
description: Run go unit tests and report to codecov
run:
  source: smithy
  on-promotion: true
  on-pull-request: true
  when-branch-name-is: master
env:
  - CODECOV_TOKEN=bQ4MgjJ0G2Y73v8JNX6L7yMK9679nbYB
  - SOURCE=/go/src/github.com/Workiva/platform
  - GO111MODULE=on
scripts:
  - go get github.com/tebeka/go2xunit
  - rm -rf ${SOURCE}
  - mkdir -p ${SOURCE}
  - cp -r ./ ${SOURCE}
  - cd ${SOURCE}
  - mkdir -p out
  - go fmt ./...
  - go test -v ./... -coverprofile=out/cover.cov | tee out/go.log
  - go2xunit -input=out/go.log -output=out/go-xunit.xml
  - bash <(curl -s https://codecov.workiva.net/bash) -t $CODECOV_TOKEN -r Workiva/platform -f out/cover.cov -F go-unit -C $SKYNET_BUILD_COMMIT_HASH
artifacts:
  - /go/src/github.com/Workiva/platform/out
test-reports:
  - /go/src/github.com/Workiva/platform/out
size: small
timeout: moderate
---
name: build-integration
image: drydock.workiva.net/workiva/skynet-images:docker_runner-latest
contact: Nate Woods (nate.woods@workiva.com)
description: Run builder and ensure results are as expected!
requires:
  Workiva/platform: docker
scripts:
  - cd test/package && ./run
size: small
timeout: moderate
---
name: update
image: bash:5
scripts:
  # Install helm
  - wget -q https://get.helm.sh/helm-v3.0.1-linux-amd64.tar.gz
  - echo "6de3337bb7683fd62f915d156cfc13c1cf73dc183bd39f2fb4644498c7595805  helm-v3.0.1-linux-amd64.tar.gz" | sha256sum -c
  - tar xf helm-v3.0.1-linux-amd64.tar.gz
  - cp linux-amd64/helm /usr/local/bin
  - rm -rf helm-v3.0.1-linux-amd64.tar.gz linux-amd64
  # Actual test
  - ./helm/gen.sh --check
